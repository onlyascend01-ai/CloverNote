<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloverDrive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #064e3b;
            --primary-light: #0d6d53;
            --bg: #ffffff;
            --sidebar-bg: #f9fafb;
            --border: #f1f5f9;
            --text: #1e293b;
            --ease-premium: cubic-bezier(0.22, 1, 0.36, 1);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .h-screen { height: 100vh; }

        /* Titlebar */
        .titlebar {
            height: 44px;
            background: var(--primary);
            display: flex; align-items: center; justify-content: space-between;
            -webkit-app-region: drag; color: white; z-index: 9999;
            position: relative; border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .no-drag { -webkit-app-region: no-drag; }

        .control-btn { width: 46px; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
        .control-btn:hover { background: rgba(255,255,255,0.1); }
        .control-btn.close:hover { background: #e81123; }

        .sidebar-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px; border-radius: 12px;
            font-size: 13px; font-weight: 700; color: #64748b;
            cursor: pointer; transition: all 0.3s var(--ease-premium);
            margin-bottom: 2px;
        }
        .sidebar-item:hover { background: white; color: var(--primary); transform: translateX(4px); }
        .sidebar-item.active { background: white; color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }

        .file-card {
            background: white; border: 1px solid #f1f5f9;
            border-radius: 24px; padding: 24px;
            transition: all 0.4s var(--ease-premium);
            cursor: pointer; position: relative;
            display: flex; flex-direction: column;
            will-change: transform, opacity;
        }
        .file-card:hover {
            transform: translateY(-8px);
            border-color: #d1fae5;
            box-shadow: 0 20px 40px -12px rgba(0,0,0,0.08);
        }

        .file-card.selecting { padding-left: 56px; }
        .selection-checkbox {
            position: absolute; left: -40px; top: 50%; transform: translateY(-50%);
            width: 22px; height: 22px; border: 2px solid #e2e8f0; border-radius: 7px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.4s var(--ease-premium);
            background: transparent; pointer-events: none;
            opacity: 0;
        }
        .file-card.selecting .selection-checkbox { left: 16px; opacity: 1; pointer-events: auto; }
        .selection-checkbox.checked { background: var(--primary); border-color: var(--primary); }
        .selection-checkbox svg { color: white; width: 14px; height: 14px; display: none; }
        .selection-checkbox.checked svg { display: block; }

        .icon-box {
            width: 56px; height: 56px;
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px;
            transition: transform 0.3s var(--ease-premium);
        }
        .file-card:hover .icon-box { transform: scale(1.1) rotate(5deg); }

        .action-btn {
            width: 32px; height: 32px;
            background: #f8fafc; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: #94a3b8; transition: all 0.3s var(--ease-premium);
            border: none; cursor: pointer;
        }
        .action-btn:hover { transform: scale(1.1); }
        .download-btn:hover { background: var(--primary); color: white; }
        .delete-btn:hover { background: #fee2e2; color: #ef4444; }
        .star-btn.starred { color: #fbbf24; }
        .star-btn:hover { background: #fffbeb; color: #fbbf24; }
        .star-btn svg { transition: transform 0.3s var(--ease-premium); }
        .star-btn:active svg { transform: scale(1.4) rotate(15deg); }

        .file-actions {
            position: absolute; top: 16px; right: 16px;
            display: flex; gap: 8px; opacity: 0; transition: all 0.2s;
        }
        .file-card:hover .file-actions { opacity: 1; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.6s var(--ease-premium) forwards; }

        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }
        .animate-fade-out { animation: fadeOut 0.4s var(--ease-premium) forwards; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #e2e8f0; border-radius: 20px; }

        .search-container {
            background: #f8fafc; border-radius: 14px;
            padding: 0 16px; height: 44px;
            display: flex; align-items: center;
            width: 320px; transition: all 0.3s var(--ease-premium);
            border: 1px solid transparent;
        }
        .search-container:focus-within { background: white; width: 400px; border-color: var(--primary-light); box-shadow: 0 4px 20px rgba(6, 78, 59, 0.05); }
        .search-container input { background: transparent; border: none; outline: none; width: 100%; margin-left: 12px; font-weight: 600; font-size: 13px; }

        .settings-card { background: white; border-radius: 24px; padding: 32px; border: 1px solid #f1f5f9; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(12px);
            display: flex; align-items: center; justify-content: center; z-index: 10000;
            opacity: 0; pointer-events: none; transition: all 0.5s var(--ease-premium);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; border-radius: 40px; width: 90%; max-width: 440px; min-height: 520px; padding: 0;
            text-align: center; transform: translateY(20px) scale(0.95);
            transition: all 0.5s var(--ease-premium); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            position: relative; overflow: hidden;
        }
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); }

        .btn-danger { background: #ef4444; color: white; width: 100%; padding: 16px; border-radius: 16px; font-weight: 800; border: none; transition: all 0.2s; cursor: pointer; }
        .btn-danger:active { transform: scale(0.98); }
        .btn-secondary { background: #f1f5f9; color: #475569; width: 100%; padding: 16px; border-radius: 16px; font-weight: 800; border: none; transition: all 0.2s; cursor: pointer; }
        .btn-secondary:active { transform: scale(0.98); }

        /* Advanced Modal Transitions */
        .modal-view-container {
            position: absolute; inset: 0; padding: 48px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.6s var(--ease-premium);
            background: white; width: 100%; height: 100%;
            z-index: 1;
        }
        .modal-exit { opacity: 0; transform: scale(0.9) translateY(-30px); pointer-events: none; }
        .modal-enter { opacity: 0; transform: scale(1.1) translateY(30px); pointer-events: none; }

        #checkout-view {
            position: fixed; inset: 0; background: white; z-index: 500;
            display: none; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.5s var(--ease-premium);
        }
        #checkout-view.active { display: flex; transform: translateY(0); }

        .bulk-actions {
            display: flex; gap: 8px; padding: 16px;
            background: white; border-top: 1px solid #f1f5f9;
            position: absolute; bottom: 0; width: 100%; z-index: 50;
            transition: transform 0.4s var(--ease-premium);
            transform: translateY(100%);
        }
        .bulk-actions.active { transform: translateY(0); }

        .pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-top: 32px; }
        .pricing-card {
            background: #f8fafc; border: 2px solid #f1f5f9; border-radius: 24px; padding: 32px;
            text-align: center; transition: all 0.3s var(--ease-premium); cursor: pointer;
            position: relative;
        }
        .pricing-card:hover { border-color: var(--primary); background: white; transform: translateY(-4px); }
        .pricing-card.selected { border-color: var(--primary); background: #f0fdf4; box-shadow: 0 10px 30px -10px rgba(6, 78, 59, 0.1); }
        .pricing-card.selected::after {
            content: '✓'; position: absolute; top: 12px; right: 12px;
            width: 24px; height: 24px; background: var(--primary); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 900;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

<!-- Titlebar -->
<div class="titlebar">
    <div class="flex items-center h-full">
        <div class="no-drag flex items-center">
            <img src="../CloverNote.png" class="w-4 h-4 mx-4">
            <span class="text-[10px] font-black uppercase tracking-[0.4em] opacity-60">CloverDrive</span>
        </div>
    </div>
    <div class="flex h-full no-drag">
        <div id="min-btn" class="control-btn" onclick="window.electronAPI.minimize()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </div>
        <div id="max-btn" class="control-btn" onclick="window.electronAPI.maximize()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
        </div>
        <div id="close-btn" class="control-btn close" onclick="window.electronAPI.close()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>
</div>

<div class="flex-1 flex overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-80 bg-[#f9fafb] border-r border-gray-100 flex flex-col p-8">
        <button id="upload-btn" class="w-full bg-[#064e3b] text-white py-4.5 rounded-[1.25rem] font-bold text-sm shadow-2xl shadow-emerald-900/20 active:scale-95 transition-all mb-10 flex items-center justify-center gap-3 group no-drag">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            Upload Files
        </button>

        <nav class="space-y-1 flex-1 no-drag">
            <div class="sidebar-item active tab-link" data-tab="all" onclick="switchTab('all', this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                All Files
            </div>
            <div class="sidebar-item tab-link" data-tab="recents" onclick="switchTab('recents', this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Recents
            </div>
            <div class="sidebar-item tab-link" data-tab="starred" onclick="switchTab('starred', this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                Starred
            </div>
            <div class="sidebar-item tab-link" data-tab="settings" onclick="switchTab('settings', this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Settings
            </div>
            <div class="sidebar-item tab-link" data-tab="trash" onclick="switchTab('trash', this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                Trash
            </div>
        </nav>

        <div class="pt-8 border-t border-gray-100">
            <div class="flex items-center justify-between mb-3 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">
                <span>Storage Vault</span>
                <span class="text-emerald-600">Secure</span>
            </div>
            <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full bg-emerald-600 w-3/4 rounded-full" id="storage-bar"></div>
            </div>
            <div class="flex justify-between mt-4">
                <p class="text-[10px] text-slate-400 font-bold" id="storage-text">Calculating...</p>
                <button onclick="showCheckout()" id="upgrade-sidebar-btn" class="text-[9px] font-black text-emerald-700 uppercase tracking-widest hover:underline no-drag">Upgrade</button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col bg-white overflow-hidden relative">

        <!-- Files View -->
        <div id="files-view" class="flex-1 flex flex-col">
            <header class="h-24 px-12 flex items-center justify-between border-b border-gray-50 bg-white/50 backdrop-blur-xl sticky top-0 z-10">
                <h2 class="text-3xl font-black tracking-tight text-slate-900" id="view-title">All Files</h2>
                <div class="flex items-center gap-6 no-drag">
                    <button onclick="toggleSelectionMode()" class="text-[10px] font-black uppercase text-emerald-600 tracking-widest px-3 py-2 bg-emerald-50 rounded-xl transition-all" id="select-mode-btn">Select</button>
                    <div class="search-container">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" placeholder="Search your vault..." oninput="filterFiles(this.value)">
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-12 animate-fade-in bg-white" id="main-scroll">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8" id="file-grid"></div>
            </div>

            <div id="bulk-bar" class="bulk-actions">
                <button onclick="selectAll()" class="flex-1 btn-secondary !mt-0">Select All</button>
                <button onclick="confirmBulkAction('trash')" class="flex-1 btn-secondary !mt-0 !bg-slate-100">Trash (<span id="selected-count">0</span>)</button>
                <button onclick="confirmBulkAction('delete')" class="flex-1 btn-danger !mt-0">Permanent Delete</button>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="flex-1 flex flex-col hidden animate-fade-in bg-[#f9fafb]">
            <header class="h-24 px-12 flex items-center border-b border-gray-50">
                <h2 class="text-3xl font-black tracking-tight text-slate-900">Preferences</h2>
            </header>
            <div class="flex-1 overflow-y-auto p-12 space-y-8">
                <div class="max-w-3xl space-y-8">
                    <section class="settings-card shadow-sm border border-gray-100 text-left">
                        <h3 class="text-lg font-bold mb-6 flex items-center gap-2"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> Identity</h3>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-bold text-slate-800">Local Vault Account</p>
                                <p class="text-xs text-slate-400">Your files are stored locally on this machine.</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <span id="plan-badge" class="px-3 py-1 bg-emerald-50 text-emerald-700 rounded-full text-[10px] font-black uppercase">Standard</span>
                                <button onclick="showCheckout()" id="upgrade-settings-btn" class="px-4 py-2 bg-amber-400 text-amber-950 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-amber-400/20 active:scale-95 transition-all">Upgrade Plan</button>
                            </div>
                        </div>
                    </section>

                    <section id="pricing-section" class="settings-card shadow-sm border border-gray-100 text-left hidden">
                        <h3 class="text-lg font-bold mb-2">Select a Plan</h3>
                        <p class="text-xs text-slate-500 mb-6">Choose the storage capacity that fits your needs.</p>
                        <div class="pricing-grid">
                            <div onclick="selectPlan('premium', this)" class="pricing-card">
                                <div class="text-[10px] font-black text-emerald-700 uppercase mb-2">Premium</div>
                                <div class="text-2xl font-black mb-1">100 GB</div>
                                <div class="text-xs text-slate-500">$9.99/mo</div>
                            </div>
                            <div onclick="selectPlan('advanced', this)" class="pricing-card">
                                <div class="text-[10px] font-black text-emerald-700 uppercase mb-2">Advanced</div>
                                <div class="text-2xl font-black mb-1">500 GB</div>
                                <div class="text-xs text-slate-500">$19.99/mo</div>
                            </div>
                            <div onclick="selectPlan('ultra', this)" class="pricing-card">
                                <div class="text-[10px] font-black text-emerald-700 uppercase mb-2">Ultra</div>
                                <div class="text-2xl font-black mb-1">2 TB</div>
                                <div class="text-xs text-slate-500">$49.99/mo</div>
                            </div>
                        </div>
                        <button id="confirm-plan-btn" disabled onclick="confirmSelectedPlan()" class="w-full mt-8 py-4 bg-emerald-900 text-white rounded-2xl font-black text-sm uppercase tracking-widest opacity-30 cursor-not-allowed transition-all active:scale-95">
                            Confirm & Continue to Checkout
                        </button>
                    </section>

                    <section class="settings-card border-red-100 shadow-sm text-left">
                        <h3 class="text-lg font-bold mb-6 flex items-center gap-2 text-red-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> Danger Zone</h3>
                        <button onclick="confirmWipeVault()" class="px-6 py-3 bg-red-50 text-red-600 rounded-xl font-bold text-xs uppercase tracking-widest hover:bg-red-600 hover:text-white transition-all flex items-center gap-2">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            Wipe Local Vault
                        </button>
                    </section>
                </div>
            </div>
        </div>

        <!-- Checkout View -->
        <div id="checkout-view" class="absolute inset-0 bg-white z-[500] hidden flex flex-col animate-fade-in">
            <header class="h-16 border-b flex items-center justify-between px-10 bg-gray-50/50 backdrop-blur">
                <span class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400">Secure Native Checkout</span>
                <button onclick="hideCheckout()" class="p-2 hover:bg-gray-200 rounded-xl transition-all"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </header>
            <iframe id="checkout-frame" src="" class="flex-1 w-full border-none"></iframe>
        </div>

    </main>
</div>

<!-- Confirm Modal -->
<div id="confirm-modal" class="modal-overlay">
    <div class="modal-content">
        <!-- Choice View (Trash or Permanent) -->
        <div class="modal-view-container" id="view-choice">
            <div id="modal-icon-container" class="w-20 h-20 bg-amber-50 text-amber-500 rounded-[2rem] flex items-center justify-center mx-auto mb-8 shadow-inner flex-shrink-0">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            </div>
            <h3 id="choice-modal-title" class="text-3xl font-black text-slate-900 mb-4 tracking-tight">Delete Item?</h3>
            <p id="choice-modal-desc" class="text-slate-500 mb-10 font-medium leading-relaxed px-4">Would you like to move this to the trash or delete it permanently?</p>
            <div class="w-full space-y-4">
                <button onclick="transitionToScrub()" class="btn-danger">Permanent Delete</button>
                <button onclick="executeTrashAction()" class="btn-secondary !bg-slate-100 !mt-0">Move to Trash</button>
                <button onclick="hideConfirm()" class="btn-secondary !mt-0">Cancel</button>
            </div>
        </div>

        <!-- Scrub View (Final confirmation) -->
        <div class="modal-view-container modal-enter hidden" id="view-scrub">
            <div class="w-20 h-20 bg-red-50 text-red-500 rounded-[2rem] flex items-center justify-center mb-8 shadow-inner mx-auto flex-shrink-0">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </div>
            <h3 class="text-3xl font-black text-slate-900 mb-4 tracking-tight">Are you sure?</h3>
            <p class="text-slate-500 mb-10 font-medium leading-relaxed px-4">This action is IRREVERSIBLE. Selected items will be scrubbed from your drive forever.</p>
            <div class="w-full space-y-4">
                <button onclick="executeFinalScrub()" class="btn-danger">Yes, Scrub Forever</button>
                <button id="btn-scrub-back" onclick="handleScrubBack()" class="btn-secondary !mt-0">Go Back</button>
            </div>
        </div>

        <!-- Dedicated Bulk Trash View -->
        <div class="modal-view-container modal-enter hidden" id="view-trash-confirm">
            <div class="w-20 h-20 bg-slate-50 text-slate-500 rounded-[2rem] flex items-center justify-center mb-8 shadow-inner mx-auto flex-shrink-0">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            </div>
            <h3 id="trash-confirm-title" class="text-3xl font-black text-slate-900 mb-4 tracking-tight">Move to Trash?</h3>
            <p class="text-slate-500 mb-10 font-medium leading-relaxed px-4">Selected items will be moved to your trash vault. You can restore them later if needed.</p>
            <div class="w-full space-y-4">
                <button onclick="executeTrashAction()" class="btn-secondary !bg-slate-900 !text-white">Move to Trash</button>
                <button onclick="hideConfirm()" class="btn-secondary !mt-0">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    let files = [];
    let currentTab = 'all';
    let targetPaths = [];
    let isSelecting = false;
    let selectedIds = new Set();
    let starredIds = new Set(JSON.parse(localStorage.getItem('clover-drive-starred') || '[]'));
    let cameFromChoice = false;

    const icons = {
        download: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
        trashSmall: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',
        check: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',
        star: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
        starFilled: '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
        restore: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>'
    };

    async function refreshFiles() {
        if(window.electronAPI) {
            files = await window.electronAPI.getFiles();
            renderFiles();
            updateStorageUI();
        }
    }

    function updateStorageUI() {
        const totalSizeKB = files.reduce((acc, f) => acc + parseFloat(f.size || 0), 0);
        const totalSizeMB = (totalSizeKB / 1024).toFixed(1);
        const currentTier = localStorage.getItem('clover-drive-tier') || 'free';
        const limitMB = { 'free': 15360, 'premium': 102400, 'advanced': 512000, 'ultra': 2097152 }[currentTier] || 15360;
        const percent = Math.min((totalSizeMB / limitMB) * 100, 100);
        document.getElementById('storage-bar').style.width = percent + '%';
        let limitText = (limitMB / 1024).toFixed(0) + ' GB';
        if (limitMB >= 1048576) limitText = (limitMB / 1048576).toFixed(0) + ' TB';
        document.getElementById('storage-text').textContent = `${totalSizeMB} MB of ${limitText} used`;
        document.getElementById('plan-badge').textContent = currentTier.charAt(0).toUpperCase() + currentTier.slice(1);
    }

    function init() {
        if(window.electronAPI) {
            document.getElementById('min-btn').onclick = () => window.electronAPI.minimize();
            document.getElementById('max-btn').onclick = () => window.electronAPI.maximize();
            document.getElementById('close-btn').onclick = () => window.electronAPI.close();
            document.getElementById('upload-btn').onclick = async () => {
                const success = await window.electronAPI.uploadFile();
                if (success) await refreshFiles();
            };
        }
        refreshFiles();

        window.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'payment-success' && selectedTier) {
                localStorage.setItem('clover-drive-tier', selectedTier);
                updateStorageUI();
                hideCheckout();
                document.getElementById('pricing-section').classList.add('hidden');
            }
        });
    }

    function showCheckout() {
        const settingsTab = document.querySelector('[data-tab="settings"]');
        if (currentTab !== 'settings') {
            switchTab('settings', settingsTab);
        }
        document.getElementById('pricing-section').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('pricing-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }

    function hideCheckout() {
        const view = document.getElementById('checkout-view');
        view.classList.remove('active');
        setTimeout(() => view.classList.add('hidden'), 500);
    }

    let selectedTier = null;
    function selectPlan(tier, el) {
        selectedTier = tier;
        document.querySelectorAll('.pricing-card').forEach(card => card.classList.remove('selected'));
        el.classList.add('selected');
        const confirmBtn = document.getElementById('confirm-plan-btn');
        confirmBtn.disabled = false;
        confirmBtn.classList.remove('opacity-30', 'cursor-not-allowed');
    }

    function confirmSelectedPlan() {
        if (!selectedTier) return;
        const view = document.getElementById('checkout-view');
        const frame = document.getElementById('checkout-frame');
        frame.src = `../checkout.html?plan=${selectedTier}`;
        view.classList.remove('hidden');
        // Force reflow for transition
        view.offsetHeight;
        view.classList.add('active');
    }

    function showModalView(viewId) {
        const views = ['view-choice', 'view-scrub', 'view-trash-confirm'];
        const targetView = document.getElementById(viewId);

        // Find currently visible view
        const activeView = views.map(id => document.getElementById(id)).find(el => !el.classList.contains('hidden') && !el.classList.contains('modal-exit'));

        if (activeView && activeView.id !== viewId) {
            activeView.classList.add('modal-exit');
            setTimeout(() => {
                activeView.classList.add('hidden');
                activeView.classList.remove('modal-exit');

                targetView.classList.remove('hidden');
                targetView.classList.add('modal-enter');
                // Use double RAF to ensure the 'modal-enter' state is applied before removing it
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        targetView.classList.remove('modal-enter');
                    });
                });
            }, 500);
        } else {
            // First time showing modal
            views.forEach(id => document.getElementById(id).classList.add('hidden'));
            targetView.classList.remove('hidden', 'modal-exit', 'modal-enter');
            document.getElementById('confirm-modal').classList.add('active');
        }
    }

    function transitionToScrub() { cameFromChoice = true; showModalView('view-scrub'); }
    function handleScrubBack() {
        if (cameFromChoice) showModalView('view-choice');
        else hideConfirm();
    }

    async function executeFinalScrub() {
        for (const path of targetPaths) await window.electronAPI.deleteFile(path);
        finishAction();
    }

    async function executeTrashAction() {
        for (const path of targetPaths) await window.electronAPI.moveToTrash(path);
        finishAction();
    }

    function finishAction() {
        if (isSelecting) toggleSelectionMode();
        refreshFiles();
        hideConfirm();
    }

    function renderFiles(filterText = '') {
        const grid = document.getElementById('file-grid');
        grid.innerHTML = '';
        let filteredFiles = files;
        if (currentTab === 'starred') filteredFiles = filteredFiles.filter(f => starredIds.has(f.id));
        else if (currentTab === 'trash') filteredFiles = filteredFiles.filter(f => f.inTrash);
        else filteredFiles = filteredFiles.filter(f => !f.inTrash);
        if (filterText) filteredFiles = filteredFiles.filter(f => f.name.toLowerCase().includes(filterText.toLowerCase()));

        filteredFiles.forEach(file => {
            const card = document.createElement('div');
            card.className = `file-card animate-fade-in ${isSelecting ? 'selecting' : ''}`;
            card.dataset.id = file.id;
            let isChecked = selectedIds.has(file.id);
            const isStarred = starredIds.has(file.id);
            card.innerHTML = `
                <div class="selection-checkbox ${isChecked ? 'checked' : ''}">${icons.check}</div>
                <div class="file-actions no-drag">
                    ${!file.inTrash ? `
                        <button class="action-btn star-btn ${isStarred ? 'starred' : ''}" onclick="toggleStar(event, '${file.id}')">${isStarred ? icons.starFilled : icons.star}</button>
                        <button class="action-btn download-btn" onclick="handleDownload(event, '${file.path.replace(/\\/g, '\\\\')}', '${file.name}')">${icons.download}</button>
                        <button class="action-btn delete-btn" onclick="showChoicePopup(event, '${file.path.replace(/\\/g, '\\\\')}')">${icons.trashSmall}</button>
                    ` : `
                        <button class="action-btn" title="Restore" onclick="handleRestore(event, '${file.path.replace(/\\/g, '\\\\')}')">${icons.restore}</button>
                        <button class="action-btn delete-btn" title="Delete Permanently" onclick="showScrubPopup(event, '${file.path.replace(/\\/g, '\\\\')}', false)">${icons.trashSmall}</button>
                    `}
                </div>
                <div class="icon-box ${getColorForType(file.type)}">${getIconForType(file.type)}</div>
                <div class="font-black text-slate-800 text-lg mb-1 truncate">${file.name}</div>
                <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${file.size} • ${file.date}</div>
            `;
            card.onclick = () => isSelecting ? toggleNoteSelection(file.id, card) : window.electronAPI.openFile(file.path);
            grid.appendChild(card);
        });

        if (currentTab !== 'starred' && currentTab !== 'trash' && currentTab !== 'recents') {
            const addCard = document.createElement('div');
            addCard.className = 'file-card border-dashed border-2 bg-slate-50/30 flex items-center justify-center';
            addCard.onclick = () => document.getElementById('upload-btn').click();
            addCard.innerHTML = `<div class="flex flex-col items-center gap-3 opacity-30 hover:opacity-100 transition-opacity"><div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></div><span class="text-[10px] font-black uppercase tracking-widest">Add New</span></div>`;
            grid.appendChild(addCard);
        }
    }

    function showChoicePopup(e, path) {
        if (e) e.stopPropagation();
        targetPaths = [path];
        cameFromChoice = false;
        showModalView('view-choice');
    }

    function showScrubPopup(e, path) {
        if (e) e.stopPropagation();
        if (path) targetPaths = [path];
        cameFromChoice = false;
        showModalView('view-scrub');
    }

    function showTrashPopup(paths) {
        targetPaths = paths;
        showModalView('view-trash-confirm');
    }

    function confirmBulkAction(action) {
        const paths = Array.from(selectedIds).map(id => files.find(f => f.id === id).path);
        if (action === 'trash') {
            showTrashPopup(paths);
        } else {
            showScrubPopup(null, null);
        }
    }

    async function handleRestore(e, path) {
        e.stopPropagation();
        await window.electronAPI.restoreFromTrash(path);
        refreshFiles();
    }

    function toggleStar(e, id) {
        e.stopPropagation();
        const btn = e.currentTarget;
        const card = btn.closest('.file-card');
        if (starredIds.has(id)) {
            starredIds.delete(id); btn.classList.remove('starred'); btn.innerHTML = icons.star;
            if (currentTab === 'starred') { card.classList.add('animate-fade-out'); setTimeout(() => { card.remove(); if (document.getElementById('file-grid').children.length === 0) renderFiles(); }, 400); }
        } else { starredIds.add(id); btn.classList.add('starred'); btn.innerHTML = icons.starFilled; }
        localStorage.setItem('clover-drive-starred', JSON.stringify(Array.from(starredIds)));
    }

    function switchTab(tab, el) {
        currentTab = tab;
        document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('files-view').classList.toggle('hidden', tab === 'settings');
        document.getElementById('settings-view').classList.toggle('hidden', tab !== 'settings');
        if (tab !== 'settings') { document.getElementById('view-title').textContent = el.textContent.trim(); renderFiles(); }
    }

    function toggleSelectionMode() {
        isSelecting = !isSelecting;
        selectedIds.clear();
        document.getElementById('bulk-bar').classList.toggle('active', isSelecting);
        document.getElementById('select-mode-btn').textContent = isSelecting ? "Cancel" : "Select";
        renderFiles();
    }

    function toggleNoteSelection(id, el) {
        if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
        el.querySelector('.selection-checkbox').classList.toggle('checked', selectedIds.has(id));
        document.getElementById('selected-count').textContent = selectedIds.size;
    }

    function selectAll() {
        if(selectedIds.size === files.length) selectedIds.clear();
        else files.forEach(f => selectedIds.add(f.id));
        renderFiles();
        document.getElementById('selected-count').textContent = selectedIds.size;
    }

    function hideConfirm() {
        document.getElementById('confirm-modal').classList.remove('active');
        setTimeout(() => {
            ['view-choice', 'view-scrub', 'view-trash-confirm'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.add('hidden');
                el.classList.remove('modal-exit', 'modal-enter');
            });
        }, 500);
    }
    function handleDownload(e, path, name) { e.stopPropagation(); window.electronAPI.downloadFile(path, name); }
    function filterFiles(val) { renderFiles(val); }

    function getIconForType(ext) {
        const fileIcon = '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>';
        const imgIcon = '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>';
        return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext) ? imgIcon : fileIcon;
    }

    function getColorForType(ext) {
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'bg-amber-50 text-amber-600';
        if (['pdf', 'doc', 'docx', 'txt', 'md'].includes(ext)) return 'bg-blue-50 text-blue-600';
        return 'bg-emerald-50 text-emerald-600';
    }

    function confirmWipeVault() {
        targetPaths = files.map(f => f.path);
        showScrubPopup(null, null);
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
